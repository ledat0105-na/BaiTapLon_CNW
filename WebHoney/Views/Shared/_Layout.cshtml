<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <title>@ViewData["Title"] - Web bán mật ong</title>

    <!-- Bootstrap core CSS -->
    <link href="~/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="~/assets/css/fontawesome.css">
    <link rel="stylesheet" href="~/assets/css/templatemo-villa-agency.css">
    <link rel="stylesheet" href="~/assets/css/owl.css">
    <link rel="stylesheet" href="~/assets/css/animate.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/notifications.css" />
</head>

<body>

  <!-- ***** Preloader Start ***** -->
  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
      <span class="dot"></span>
      <div class="dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
  <!-- ***** Preloader End ***** -->

  <div class="sub-header">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-8">
          <ul class="info">
            <li><i class="fa fa-envelope"></i> tle723772@gmail.com</li>
            <li><i class="fa fa-map"></i> Số 566 Núi Thành, Phường Hòa Cường, Thành Phố Đà Nẵng</li>
          </ul>
        </div>
        <div class="col-lg-4 col-md-4">
          <ul class="social-links">
            <li><a href="https://www.facebook.com/datlee0110" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a></li>
            <li><a href="mailto:tle723772@gmail.com" target="_blank" title="Gmail"><i class="fas fa-envelope"></i></a></li>
            <li><a href="https://www.instagram.com/tindat01oct.205/" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a></li>
            <li><a href="https://zalo.me/0833562999" target="_blank" title="Zalo"><i class="fas fa-comment-dots"></i></a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ***** Header Area Start ***** -->
  <header class="header-area header-sticky">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="main-nav">
                    <!-- ***** Logo Start ***** -->
                    <a asp-controller="Home" asp-action="Index" class="logo" style="display: flex; align-items: center; gap: 10px; height: 100px; line-height: 100px;">
                        <img src="/assets/images/logoKTDN.png" alt="Logo" style="height: 40px; width: auto; object-fit: contain; display: block;">
                        <h1 style="white-space: nowrap; margin: 0; font-size: 24px; font-weight: 700; line-height: 100px;">MẬT ONG</h1>
                    </a>
                    <!-- ***** Logo End ***** -->
                    <!-- ***** Menu Start ***** -->
                    <ul class="nav">
                      <li><a asp-controller="Home" asp-action="Index" class="@(ViewContext.RouteData.Values["Action"]?.ToString() == "Index" ? "active" : "")">Trang chủ</a></li>
                      <li><a asp-controller="Shop" asp-action="Index" class="@(ViewContext.RouteData.Values["Controller"]?.ToString() == "Shop" ? "active" : "")">Sản phẩm</a></li>
                      <li><a asp-controller="Home" asp-action="Contact" class="@(ViewContext.RouteData.Values["Action"]?.ToString() == "Contact" ? "active" : "")">Liên hệ</a></li>
                      <li>
                          <a asp-controller="Cart" asp-action="Index" id="cart-link">
                              <i class="fa fa-shopping-cart"></i> Giỏ hàng 
                              <span class="badge bg-danger" id="cart-badge" style="display: none;">0</span>
                          </a>
                      </li>
                      @{
                          var userId = Context.Session.GetString("UserId");
                          var username = Context.Session.GetString("Username");
                          var fullName = Context.Session.GetString("FullName");
                          var role = Context.Session.GetString("Role");
                      }
                      @if (!string.IsNullOrEmpty(userId))
                      {
                          <li class="notification-menu-item" style="position: relative;">
                              <a href="#" class="notification-bell-link" data-bs-toggle="dropdown" aria-expanded="false">
                                  <i class="fa fa-bell"></i> Thông báo
                                  <span class="notification-badge-user" id="notificationBadgeUser" style="display: none;">0</span>
                              </a>
                              <ul class="dropdown-menu dropdown-menu-end notification-dropdown-user" style="min-width: 350px; max-height: 500px; overflow-y: auto;">
                                  <li class="dropdown-header d-flex justify-content-between align-items-center">
                                      <span><strong>Thông báo</strong></span>
                                      <button type="button" class="btn btn-sm btn-link p-0" id="markAllReadBtnUser" style="font-size: 12px;">Đánh dấu tất cả đã đọc</button>
                                  </li>
                                  <li><hr class="dropdown-divider"></li>
                                  <li id="notificationListUser">
                                      <div class="text-center p-3 text-muted">
                                          <i class="fa fa-spinner fa-spin"></i> Đang tải...
                                      </div>
                                  </li>
                              </ul>
                          </li>
                          <li>
                              <a asp-controller="Account" asp-action="Profile">
                                  <i class="fa fa-user"></i> @(string.IsNullOrEmpty(fullName) ? username : fullName)
                                  @if (role == "ADMIN" || role == "Admin")
                                  {
                                      <span class="badge badge-danger" style="background-color: #dc3545; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">Admin</span>
                                  }
                              </a>
                          </li>
                          @if (role == "ADMIN" || role == "Admin")
                          {
                              <li><a asp-controller="Admin" asp-action="Index"><i class="fa fa-dashboard"></i> Quản trị</a></li>
                          }
                          <li><a asp-controller="Account" asp-action="Logout"><i class="fa fa-sign-out"></i> Đăng xuất</a></li>
                      }
                      else
                      {
                          <li><a asp-controller="Account" asp-action="Login"><i class="fa fa-sign-in"></i> Đăng nhập</a></li>
                          <li><a asp-controller="Account" asp-action="Register"><i class="fa fa-user-plus"></i> Đăng ký</a></li>
                      }
                  </ul>   
                    <a class='menu-trigger'>
                        <span>Menu</span>
                    </a>
                    <!-- ***** Menu End ***** -->
                </nav>
                
            </div>
        </div>
    </div>
  </header>
  <!-- ***** Header Area End ***** -->

  <main>
    @RenderBody()
  </main>

  <footer class="honey-footer mt-5">
    <div class="container py-5">
      <div class="row gy-4">
        <!-- Cột 1: Logo + mô tả ngắn -->
        <div class="col-lg-4 col-md-6">
          <div class="honey-footer-logo mb-3">
            <h3 class="mb-0">Mật Ong</h3>
          </div>
          <p class="honey-footer-text mb-3">
            Mật ong thiên nhiên nguyên chất, được tuyển chọn kỹ lưỡng từ các vùng nguyên liệu sạch trên khắp Việt Nam.
          </p>
          <p class="honey-footer-text small mb-0">
            © 2025 Web bán mật ong. All rights reserved.
          </p>
        </div>

        <!-- Cột 2: Menu nhanh -->
        <div class="col-lg-4 col-md-6">
          <h5 class="honey-footer-title mb-3">Menu nhanh</h5>
          <ul class="list-unstyled honey-footer-links">
            <li><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li><a asp-controller="Shop" asp-action="Index">Sản phẩm</a></li>
            <li><a asp-controller="Home" asp-action="Contact">Liên hệ</a></li>
            <li><a asp-controller="Home" asp-action="Index">Giới thiệu</a></li>
          </ul>
        </div>

        <!-- Cột 3: Thông tin liên hệ -->
        <div class="col-lg-4 col-md-12">
          <h5 class="honey-footer-title mb-3">Liên hệ</h5>
          <ul class="list-unstyled honey-footer-contact">
            <li>
              <i class="fa fa-map-marker-alt me-2"></i>
              <span>Sunny Isles Beach, FL 33160</span>
            </li>
            <li>
              <i class="fa fa-envelope me-2"></i>
              <span>info@matong.com</span>
            </li>
            <li>
              <i class="fa fa-phone me-2"></i>
              <span>0123 456 789</span>
            </li>
          </ul>
          <div class="honey-footer-social mt-3">
            <a href="https://www.facebook.com/datlee0110" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="mailto:tle723772@gmail.com" target="_blank" title="Gmail"><i class="fas fa-envelope"></i></a>
            <a href="https://www.instagram.com/tindat01oct.205/" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://zalo.me/0833562999" target="_blank" title="Zalo"><i class="fas fa-comment-dots"></i></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <!-- Bootstrap core JavaScript -->
  <script src="~/vendor/jquery/jquery.min.js"></script>
  <script src="~/vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="~/assets/js/isotope.min.js"></script>
  <script src="~/assets/js/owl-carousel.js"></script>
  <script src="~/assets/js/counter.js"></script>
  <script src="~/assets/js/custom.js"></script>
  
  @await RenderSectionAsync("Scripts", required: false)
  
  <script>
    // Hàm cập nhật số lượng giỏ hàng
    function updateCartCount() {
      fetch('/Cart/Count')
        .then(response => response.json())
        .then(data => {
          const badge = document.getElementById('cart-badge');
          if (badge) {
            if (data.count > 0) {
              badge.textContent = data.count;
              badge.style.display = 'inline';
            } else {
              badge.style.display = 'none';
            }
          }
        })
        .catch(error => console.error('Error updating cart count:', error));
    }
    
    // Cập nhật số lượng khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      updateCartCount();
    });

    // Load notifications for user
    @if (!string.IsNullOrEmpty(userId))
    {
        <text>
        $(document).ready(function() {
            loadUserNotifications();
            loadUserUnreadCount();

            // Refresh notifications every 30 seconds
            setInterval(function() {
                loadUserUnreadCount();
            }, 30000);
        });

        function loadUserUnreadCount() {
            $.get('@Url.Action("GetUnreadCount", "Notification")', function(data) {
                var badge = $('#notificationBadgeUser');
                if (badge.length && data.count > 0) {
                    badge.text(data.count > 99 ? '99+' : data.count).show();
                } else if (badge.length) {
                    badge.hide();
                }
            });
        }

        function loadUserNotifications() {
            $.get('@Url.Action("GetNotifications", "Notification")', { limit: 10 }, function(data) {
                var list = $('#notificationListUser');
                if (!list.length) return;
                
                if (data.notifications.length === 0) {
                    list.html('<div class="text-center p-3 text-muted"><i class="fa fa-bell-slash"></i><br>Không có thông báo</div>');
                    return;
                }

                var html = '';
                data.notifications.forEach(function(notif) {
                    var icon = 'fa-info-circle';
                    var bgClass = 'bg-info';
                    if (notif.type === 'SUCCESS') {
                        icon = 'fa-check-circle';
                        bgClass = 'bg-success';
                    } else if (notif.type === 'ERROR') {
                        icon = 'fa-exclamation-circle';
                        bgClass = 'bg-danger';
                    } else if (notif.type === 'WARNING') {
                        icon = 'fa-exclamation-triangle';
                        bgClass = 'bg-warning';
                    }

                    var readClass = notif.isRead ? '' : 'notification-unread';
                    var link = '';
                    if (notif.relatedType === 'ORDER' && notif.relatedId) {
                        link = '/Cart/MyOrderDetails/' + notif.relatedId;
                    }

                    html += '<li class="notification-item ' + readClass + '">';
                    html += '<a href="' + (link || '#') + '" class="dropdown-item notification-link-user" data-id="' + notif.id + '">';
                    html += '<div class="d-flex align-items-start">';
                    html += '<div class="notification-icon ' + bgClass + ' me-2"><i class="fa ' + icon + '"></i></div>';
                    html += '<div class="flex-grow-1">';
                    html += '<div class="fw-bold">' + notif.title + '</div>';
                    if (notif.message) {
                        html += '<div class="small text-muted">' + notif.message + '</div>';
                    }
                    html += '<div class="small text-muted mt-1">' + notif.createdAt + '</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '</a>';
                    html += '</li>';
                });
                list.html(html);

                // Mark as read when clicked
                $('.notification-link-user').on('click', function(e) {
                    var notifId = $(this).data('id');
                    if (notifId && !$(this).closest('.notification-item').hasClass('notification-read')) {
                        $.post('@Url.Action("MarkAsRead", "Notification")', { id: notifId, __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() });
                        $(this).closest('.notification-item').removeClass('notification-unread').addClass('notification-read');
                        loadUserUnreadCount();
                    }
                });
            });
        }

        $(document).on('click', '#markAllReadBtnUser', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $.post('@Url.Action("MarkAllAsRead", "Notification")', { __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() }, function(data) {
                if (data.success) {
                    $('.notification-item').removeClass('notification-unread').addClass('notification-read');
                    $('#notificationBadgeUser').hide();
                }
            });
        });
        </text>
    }
  </script>

  @Html.AntiForgeryToken()
  
</body>
</html>
