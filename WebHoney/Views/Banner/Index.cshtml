@model IEnumerable<WebHoney.Models.BannerImage>
@{
    ViewData["Title"] = "Quản lý banner";
    var currentPage = (int)(ViewData["CurrentPage"] ?? 1);
    var totalPages = (int)(ViewData["TotalPages"] ?? 1);
    var totalItems = (int)(ViewData["TotalItems"] ?? 0);
    var pageSize = (int)(ViewData["PageSize"] ?? 5);
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Quản lý Banner Trang Chủ</h5>
            <a asp-action="Create" class="btn btn-primary">
                <i class="fa fa-plus"></i> Thêm banner mới
            </a>
        </div>
        <div class="card-body">
            @Html.AntiForgeryToken()
            @if (Model.Any())
            {
                <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i> Kéo thả các banner để sắp xếp lại thứ tự hiển thị trên trang chủ.
                </div>
                
                <div id="banner-list" class="row">
                    @foreach (var banner in Model)
                    {
                        <div class="col-md-4 mb-4 banner-item" data-id="@banner.Id" data-order="@banner.DisplayOrder">
                            <div class="card h-100 shadow-sm">
                                <div class="position-relative">
                                    <img src="@banner.ImageUrl" class="card-img-top" alt="@banner.Title" 
                                         style="height: 250px; object-fit: cover; width: 100%;" 
                                         onerror="this.src='/images/placeholder.png'; this.onerror=null;">
                                    <span class="badge bg-@(banner.IsActive ? "success" : "secondary") position-absolute top-0 end-0 m-2">
                                        @(banner.IsActive ? "Đang hiển thị" : "Ẩn")
                                    </span>
                                    <span class="badge bg-primary position-absolute top-0 start-0 m-2">
                                        Thứ tự: @banner.DisplayOrder
                                    </span>
                                    <div class="position-absolute bottom-0 start-0 end-0 p-2 bg-dark bg-opacity-50">
                                        <small class="text-white">
                                            <i class="fa fa-image"></i> Click "Đổi ảnh" để thay đổi
                                        </small>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title fw-bold">@(string.IsNullOrEmpty(banner.Title) ? "Không có tiêu đề" : banner.Title)</h6>
                                    @if (!string.IsNullOrEmpty(banner.Subtitle))
                                    {
                                        <p class="card-text text-muted small mb-2">@banner.Subtitle</p>
                                    }
                                    <p class="text-muted small mb-0">
                                        <i class="fa fa-link"></i> <a href="@banner.ImageUrl" target="_blank" class="text-decoration-none">Xem ảnh gốc</a>
                                    </p>
                                </div>
                                <div class="card-footer bg-white">
                                    <div class="btn-group-vertical w-100" role="group">
                                        <a asp-action="Edit" asp-route-id="@banner.Id" class="btn btn-sm btn-warning mb-1">
                                            <i class="fa fa-edit"></i> Đổi ảnh / Chỉnh sửa
                                        </a>
                                        <div class="btn-group" role="group">
                                            <form asp-action="ToggleActive" asp-route-id="@banner.Id" method="post" class="d-inline flex-fill">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-@(banner.IsActive ? "secondary" : "success") w-100">
                                                    <i class="fa fa-@(banner.IsActive ? "eye-slash" : "eye")"></i> @(banner.IsActive ? "Ẩn" : "Hiện")
                                                </button>
                                            </form>
                                            <form asp-action="Delete" asp-route-id="@banner.Id" method="post" class="d-inline flex-fill" 
                                                  onsubmit="return confirm('Bạn có chắc chắn muốn xóa banner này?');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-danger w-100">
                                                    <i class="fa fa-trash"></i> Xóa
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" id="save-order-btn" class="btn btn-success" style="display: none;">
                            <i class="fa fa-save"></i> Lưu thứ tự mới
                        </button>
                    </div>
                    <div>
                        <p class="text-muted mb-0">Hiển thị <strong>@((currentPage - 1) * pageSize + 1)</strong> - <strong>@Math.Min(currentPage * pageSize, totalItems)</strong> trong tổng số <strong>@totalItems</strong> banner</p>
                    </div>
                </div>

                @if (totalPages > 1)
                {
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center mb-0">
                            @if (currentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?page=@(currentPage - 1)">Trước</a>
                                </li>
                            }
                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="?page=@i">@i</a>
                                </li>
                            }
                            @if (currentPage < totalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?page=@(currentPage + 1)">Sau</a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle"></i> Chưa có banner nào. <a asp-action="Create">Thêm banner mới</a>
                </div>
            }
        </div>
    </div>
</div>

<!-- SortableJS for drag & drop -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.css">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<style>
    .banner-item {
        cursor: move;
    }
    
    .banner-item.sortable-ghost {
        opacity: 0.4;
    }
    
    .banner-item.sortable-drag {
        opacity: 0.8;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bannerList = document.getElementById('banner-list');
            const saveOrderBtn = document.getElementById('save-order-btn');
            
            if (bannerList) {
                let sortable = Sortable.create(bannerList, {
                    animation: 150,
                    handle: '.card',
                    onEnd: function(evt) {
                        // Hiển thị nút lưu khi có thay đổi
                        saveOrderBtn.style.display = 'block';
                    }
                });

                // Lưu thứ tự mới
                saveOrderBtn.addEventListener('click', async function() {
                    const items = bannerList.querySelectorAll('.banner-item');
                    const orders = [];
                    
                    items.forEach((item, index) => {
                        orders.push({
                            id: parseInt(item.dataset.id),
                            order: index + 1
                        });
                    });

                    // Lấy CSRF token
                    const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                    const token = tokenInput ? tokenInput.value : '';

                    try {
                        const response = await fetch('@Url.Action("Reorder", "Banner")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': token
                            },
                            body: JSON.stringify(orders)
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            alert(result.message);
                            saveOrderBtn.style.display = 'none';
                            // Cập nhật số thứ tự hiển thị
                            items.forEach((item, index) => {
                                const badge = item.querySelector('.badge.bg-primary');
                                if (badge) {
                                    badge.textContent = 'Thứ tự: ' + (index + 1);
                                }
                            });
                            // Reload để cập nhật DisplayOrder
                            location.reload();
                        } else {
                            alert(result.message || 'Có lỗi xảy ra khi lưu thứ tự.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi lưu thứ tự.');
                    }
                });
            }
        });
    </script>
}

