@model List<WebHoney.Models.CartItem>
@{
    ViewData["Title"] = "Giỏ hàng";
    var cartTotal = (decimal)ViewData["CartTotal"]!;
}

<div class="page-heading header-text">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <span class="breadcrumb"><a asp-controller="Home" asp-action="Index">Trang chủ</a> / Giỏ hàng</span>
                <h3>Giỏ hàng của tôi</h3>
            </div>
        </div>
    </div>
</div>

<div class="section best-deal">
    <div class="container">
        @if (Model.Any())
        {
            <form id="cartForm">
                @Html.AntiForgeryToken()

                <div class="row">
                    <div class="col-lg-8">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Tổng</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr id="cart-item-@item.ProductId">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="@(item.ImageUrl ?? "/assets/images/property-01.jpg")" 
                                                 alt="@item.ProductName" 
                                                 style="width: 80px; height: 80px; object-fit: cover; margin-right: 15px;"
                                                 onerror="this.onerror=null; this.src='/assets/images/property-01.jpg';">
                                            <div>
                                                <strong>@item.ProductName</strong>
                                                @if (item.Stock < 10)
                                                {
                                                    <br><small class="text-warning">Còn lại: @item.Stock sản phẩm</small>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>@item.Price.ToString("#,##0") VNĐ</td>
                                    <td>
                                        <div class="input-group" style="width: 120px;">
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    type="button" 
                                                    onclick="changeQuantity(@item.ProductId, -1)">-</button>
                                            <input type="number" 
                                                   class="form-control form-control-sm text-center" 
                                                   id="qty-@item.ProductId" 
                                                   value="@item.Quantity" 
                                                   min="1" 
                                                   max="@item.Stock"
                                                   onchange="updateQuantity(@item.ProductId, parseInt(this.value))">
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    type="button" 
                                                    onclick="changeQuantity(@item.ProductId, 1)">+</button>
                                        </div>
                                    </td>
                                    <td>
                                        <strong id="total-@item.ProductId">@item.Total.ToString("#,##0")</strong> VNĐ
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(@item.ProductId)">
                                            <i class="fa fa-trash"></i> Xóa
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                                <td colspan="2">
                                    <strong id="cart-total" style="font-size: 1.2em; color: #ff6b35;">
                                        @cartTotal.ToString("#,##0") VNĐ
                                    </strong>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary" onclick="clearCart()">
                            <i class="fa fa-trash"></i> Xóa toàn bộ giỏ hàng
                        </button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>Tổng thanh toán</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Tạm tính:</span>
                                <span id="subtotal">@cartTotal.ToString("N0") VNĐ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí vận chuyển:</span>
                                <span>Miễn phí</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Tổng cộng:</strong>
                                <strong id="final-total" style="color: #ff6b35; font-size: 1.2em;">
                                    @cartTotal.ToString("N0") VNĐ
                                </strong>
                            </div>
                            <a href="@Url.Action("Checkout", "Cart")" class="btn btn-primary w-100">
                                <i class="fa fa-shopping-bag"></i> Tiến hành thanh toán
                            </a>
                            <a href="@Url.Action("Index", "Shop")" class="btn btn-outline-secondary w-100 mt-2">
                                <i class="fa fa-arrow-left"></i> Tiếp tục mua sắm
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            </form>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fa fa-shopping-cart" style="font-size: 5em; color: #ccc;"></i>
                <h3 class="mt-3">Giỏ hàng của bạn đang trống</h3>
                <p class="text-muted">Hãy thêm một số sản phẩm vào giỏ hàng của bạn!</p>
                <a href="@Url.Action("Index", "Shop")" class="btn btn-primary mt-3">
                    <i class="fa fa-shopping-bag"></i> Tiếp tục mua sắm
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function getCartToken() {
            const form = document.getElementById('cartForm');
            if (!form) return '';
            const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput?.value || '';
        }

        function changeQuantity(productId, delta) {
            const input = document.getElementById('qty-' + productId);
            if (!input) return;

            const current = parseInt(input.value || '0');
            const min = parseInt(input.min || '1');
            const max = parseInt(input.max || '999999');

            let next = current + delta;
            if (next < min) next = min;
            if (next > max) next = max;

            updateQuantity(productId, next);
        }

        function updateQuantity(productId, quantity) {
            if (quantity < 1) {
                if (confirm('Bạn có muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                    removeFromCart(productId);
                }
                return;
            }

            fetch('/Cart/Update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getCartToken()
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('qty-' + productId).value = quantity;
                    document.getElementById('total-' + productId).textContent = data.itemTotal.toLocaleString('vi-VN');
                    document.getElementById('cart-total').textContent = data.cartTotal.toLocaleString('vi-VN') + ' VNĐ';
                    document.getElementById('subtotal').textContent = data.cartTotal.toLocaleString('vi-VN') + ' VNĐ';
                    document.getElementById('final-total').textContent = data.cartTotal.toLocaleString('vi-VN') + ' VNĐ';
                    
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi cập nhật số lượng.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật số lượng.');
            });
        }

        function removeFromCart(productId) {
            if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                return;
            }

            fetch('/Cart/Remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getCartToken()
                },
                body: JSON.stringify({
                    productId: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('cart-item-' + productId).remove();
                    document.getElementById('cart-total').textContent = data.cartTotal.toLocaleString('vi-VN') + ' VNĐ';
                    document.getElementById('subtotal').textContent = data.cartTotal.toLocaleString('vi-VN') + ' VNĐ';
                    document.getElementById('final-total').textContent = data.cartTotal.toLocaleString('vi-VN') + ' VNĐ';
                    
                    if (data.cartCount === 0) {
                        location.reload();
                    }
                    
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi xóa sản phẩm.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa sản phẩm.');
            });
        }

        function clearCart() {
            if (!confirm('Bạn có chắc chắn muốn xóa toàn bộ giỏ hàng?')) {
                return;
            }

            fetch('/Cart/Clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getCartToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi xóa giỏ hàng.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa giỏ hàng.');
            });
        }
    </script>
}

