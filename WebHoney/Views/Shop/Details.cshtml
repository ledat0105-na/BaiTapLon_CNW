@model WebHoney.Models.Product
@{
    ViewData["Title"] = Model.Name;
    var relatedProducts = (List<WebHoney.Models.Product>)ViewData["RelatedProducts"] ?? new List<WebHoney.Models.Product>();
}

<div class="page-heading header-text">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <span class="breadcrumb">
                    <a asp-controller="Home" asp-action="Index">Trang chủ</a> / 
                    <a asp-controller="Shop" asp-action="Index">Sản phẩm</a> / 
                    @Model.Name
                </span>
                <h3>@Model.Name</h3>
            </div>
        </div>
    </div>
</div>

<div class="section best-deal">
    <div class="container">
        <div class="row">
            <!-- Product Images -->
            <div class="col-lg-6">
                <div class="product-image">
                    <img src="@(Model.ImageUrl ?? "/assets/images/property-01.jpg")" alt="@Model.Name" class="img-fluid" style="width: 100%; max-height: 500px; object-fit: contain;">
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-6">
                <div class="product-info">
                    <span class="category">@Model.Category?.Name</span>
                    <h2>@Model.Name</h2>
                    
                    @if (!string.IsNullOrEmpty(Model.ShortDesc))
                    {
                        <p class="lead">@Model.ShortDesc</p>
                    }

                    <div class="product-details mb-4">
                        <div class="row">
                            <div class="col-6">
                                <strong>Giá:</strong>
                            </div>
                            <div class="col-6">
                                <span class="price text-danger" style="font-size: 1.5em; font-weight: bold;">
                                    @Model.Price.ToString("#,##0") VNĐ
                                </span>
                            </div>
                        </div>

                        @if (Model.Volume.HasValue)
                        {
                            <div class="row mt-2">
                                <div class="col-6">
                                    <strong>Dung tích:</strong>
                                </div>
                                <div class="col-6">
                                    @Model.Volume @Model.Unit
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(Model.Origin))
                        {
                            <div class="row mt-2">
                                <div class="col-6">
                                    <strong>Nguồn gốc:</strong>
                                </div>
                                <div class="col-6">
                                    @Model.Origin
                                </div>
                            </div>
                        }

                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Tình trạng:</strong>
                            </div>
                            <div class="col-6">
                                @if (Model.Stock > 0)
                                {
                                    <span class="badge bg-success">Còn hàng (@Model.Stock sản phẩm)</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Hết hàng</span>
                                }
                            </div>
                        </div>
                    </div>

                    @if (Model.Stock > 0)
                    {
                        <div class="add-to-cart mb-4">
                            <div class="row">
                                <div class="col-4">
                                    <label>Số lượng:</label>
                                    <input type="number" id="quantity" class="form-control" value="1" min="1" max="@Model.Stock">
                                </div>
                                <div class="col-8 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary w-100" onclick="addToCart(@Model.Id)">
                                        <i class="fa fa-shopping-cart"></i> Thêm vào giỏ hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            Sản phẩm hiện đang hết hàng. Vui lòng quay lại sau!
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Product Description -->
        <div class="row mt-5">
            <div class="col-lg-12">
                <div class="product-description">
                    <h4>Mô tả sản phẩm</h4>
                    <div class="description-content">
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            @Html.Raw(Model.Description.Replace("\n", "<br>"))
                        }
                        else
                        {
                            <p>@Model.ShortDesc</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        @if (relatedProducts.Any())
        {
            <div class="row mt-5">
                <div class="col-lg-12">
                    <h4>Sản phẩm liên quan</h4>
                    <div class="row">
                        @foreach (var related in relatedProducts)
                        {
                            <div class="col-lg-3 col-md-4 mb-4">
                                <div class="item">
                                    <a href="@Url.Action("Details", "Shop", new { id = related.Id })">
                                        <img src="@(related.ImageUrl ?? "/assets/images/property-01.jpg")" alt="@related.Name" style="width: 100%; height: 200px; object-fit: cover;">
                                    </a>
                                    <span class="category">@related.Category?.Name</span>
                                    <h6><a href="@Url.Action("Details", "Shop", new { id = related.Id })">@related.Name</a></h6>
                                    <span class="price">@related.Price.ToString("#,##0") VNĐ</span>
                                    <div class="main-button">
                                        <a href="@Url.Action("Details", "Shop", new { id = related.Id })">Xem chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function addToCart(productId) {
            const quantity = document.getElementById('quantity').value;
            
            fetch('/Cart/Add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: parseInt(quantity)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Đã thêm sản phẩm vào giỏ hàng!');
                    // Có thể cập nhật số lượng sản phẩm trong giỏ hàng ở header
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi thêm sản phẩm vào giỏ hàng.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi thêm sản phẩm vào giỏ hàng.');
            });
        }
    </script>
}

